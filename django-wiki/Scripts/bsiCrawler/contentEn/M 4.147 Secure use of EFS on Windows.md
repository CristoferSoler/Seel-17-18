#M 4.147 Secure use of EFS on Windows
Responsible for initiation: IT security officer, IT manager

Responsible for implementation: administrator, user

Under Windows, the file system EFS (Encrypting File System) is available, which supports the encryption of individual files that must be marked for this. EFS file encryption is based on a hybrid mechanism that uses mixed asymmetric and symmetric encryption methods:

* For pure data encryption, a fast symmetric method is used. The used key (the so-called File Encryption Key, FEK) is generated randomly.
* Windows 2000 and Windows XP before Service Pack 1 use the DESX method by default, a modified form of the DES algorithm. Windows XP can be switched to FIPS 140-1 triple DES. The use of the Triple-DES encryption algorithm enables encryption with larger key lengths. The algorithm is activated in the group policies under Computer Configuration | Windows Settings | Security Settings | Local Policies | Security Options | System cryptography: Use FIPS compliant algorithm for encryption, hashing, and signature. As of Windows XP Service Pack 1, the AES algorithm with 256-bit keys is used. The encryption algorithm used can be specified by the registry entry HKLM / SOFTWARE / Microsoft / Windows NT / CurrentVersion / EFS / AlgorithmID: 0x6603 for Triple-DES, 0x6604 for DESX and 0x6610 for AES.
* Activation of the Triple DES encryption algorithm by default affects not only the EFS but also IPSec. A new entry in the registry (DWORD name: AlgorithmID, value 0x6603, under HKLM / SOFTWARE / Microsoft / Windows NT / CurrentVersion / EFS) limits the use of Triple-DES to EFS.
* When using in a mixed environment (Windows 2000 and later versions of Windows), it should be noted that Windows 2000 systems without the High-Encryption Pack (or Service Pack 2) will not be able to access files using encrypted the Triple DES algorithm. Documents encrypted with AES can not be read by Windows 2000 systems and Windows XP systems without Service Pack 1. However, these problems only occur in normal operation if the encrypted data is not decrypted on the original computer, as is possible when using removable drives with NTFS or WebDAV with EFS.
* The asymmetric RSA method is used to encode the FEK. The encryption of the FEK is done with the public key of the user who encrypts the file. Thus, the FEK can only be decrypted with the private key of this user and used to decrypt the file contents. Since Windows 7 and Server 2008 R2, the FEK can also be encrypted using the Elliptic Curve Cryptosystems (ECC) method. The method allows the use of shorter keys. As of Windows 7 and Server 2008 R2, RSA and ECC Hybrid are used to maintain compatibility with previous versions of Windows. The key words for the procedures are in Group Policy: Computer Configuration | Windows Settings | Security Settings | Public Key Policies | Encrypting file system configured. At least the default value of 2048 Bit for RSA and 256 Bit for ECC should be used. These settings are also used by default. Depending on the confidentiality requirement for the data to be encrypted, even larger key sequences can be selected.


All keys required for encryption or decryption are stored by Windows during use in a main memory area that is not moved to the page file. This is to ensure that the keys can not be compromised if an unauthorized third party gains access to the paging file. Critical in this context is the use of hibernation (Hibernation mode), since the entire memory area is stored in an encrypted file (hiberfil.sys), which then necessarily contains the key material. For this reason, hibernation should not be used when using EFS on Windows versions prior to Windows Vista and Windows Server 2008. This is especially important for mobile systems. If BitLocker is also actively used for hard-disk encryption on the systems, the hibernation file is encrypted. The hybrid standby mode available from Windows Vista should not be used for the same reason. Designed specifically for desktop systems, this power-saving mode, like hibernation, saves the contents of memory to disk before the system goes into standby. On the client side as of Windows Vista and on the server side as of Server 2008, the paging file can be encrypted as a remedy: Computer Configuration | Windows Settings | Security Settings | Public Key Policies | Encrypting file system. Click with the right mouse button and select properties in the displayed menu.

Encryption via EFS can be set by each user per file or directory. Users should be trained on how to handle EFS correctly and they should be informed about the potential weaknesses of this type of encryption. Please note the following:

* Copying or moving EFS encrypted files from an NTFS to a FAT / FAT32 destroys the files because FAT / FAT32 does not support encryption. In addition, the NTFS permissions assigned to the file are removed.
* Moving encrypted files between NTFS drives on the same computer preserves encryption as well as NTFS permissions.
* If the encrypted files are to be accessible to another computer, it is necessary to export the EFS certificate together with the key and to import it to the target computer.
* EFS does not work with compressed folders.


By using EFS, a security gain is achieved. However, users should be aware that despite the encryption of plain text files, there is a residual risk that the data of the deleted plaintext file can be partially or completely restored. However, this requires special software and access to the hard disk of the respective computer.

To ensure that files encrypted using EFS are not completely lost when the private key is lost, additional encryption of the FEK can be performed using the public key of the so-called Recovery Agent. This allows you to decrypt the data even under the recovery agent user account. In principle, any user account can be used as a recovery agent. For Windows 2000, specifying a recovery agent is mandatory, but not for Windows XP or later. By default, Windows 2000 uses the Administrator account.

When using EFS, the following must be considered from a security perspective:

* EFS is completely transparent to the user. However, with Windows 2000, a user will not notice a difference between encrypted and unscrambled files. Therefore, special attention is required that sensitive files are actually encrypted. As of Windows XP / Server 2003, the encrypted files are displayed in a different color in Windows Explorer by default. This can be seen in the Windows Explorer by the option Encrypted or compressed NTFS files in other color under Tools | Folder Options | View or Organize | Folder and Search Options | View to be controlled. As of Windows Vista / Server 2008, the command path to be used depends on the Windows Explorer view set.
* By default, EFS encrypted files are not included in the index of the Windows search function. If the encrypted files are still to be indexed for fast searching, the index must also be protected by encryption mechanisms. Otherwise, sensitive data from the index could be read out in plain text. Therefore, EFS encrypted files should not be indexed for Windows search.
* Due to the transparency for users, the protection of the EFS file encryption is as strong as the password of the respective user account. If an unauthorized third party can log in successfully under a user account, then he has access to all encrypted files of this user account. Again, strong passwords should be used for each user account. Since Windows allows to use its own password filters, this mechanism can be used to force the use of strong passwords technically.
* EFS is a file encryption, not a folder encryption. However, a folder can be marked for encryption, then any files in the folder or even files newly created in such a folder will be encrypted. However, in principle it is possible to keep and also to generate unencrypted files in such a folder (see next paragraph). Encrypted files can also exist anywhere in the file tree and are not bound to folders marked for encryption.
* Although EFS is not a folder encryption, it is recommended to keep encrypted files in special folders and to mark folders for encryption. This facilitates working with encrypted files.
* The encryption property is a file attribute treated like any other file attribute, that is, file attributes remain unchanged when files are moved. As a result, files are not automatically encrypted when they are moved to a folder that is marked for encryption. The default setting for Windows Explorer, however, is that encrypted files will also be encrypted. This behavior can be controlled through a group policy. However, this does not apply to working under the command line of Windows. Users must be aware of the risk that files in folders marked for encryption may also be unshifted.
* Encrypting a file does not provide access control. In particular, encrypted files can be deleted by third parties if the access rights permit this. In addition to the encryption of a file, therefore, corresponding settings for the access control must be made.
* The centralized use of EFS is made possible by the use of Group Policy, which among other things is used to define the recovery agents.
* For EFS to work under Windows 2000, a recovery agent must always be defined. It is advisable to create a special account for this purpose, which is used exclusively for this purpose. In particular, no administrator account should be used to limit the authority of the administrator. Depending on the identified protection needs, consideration should be given to introducing a four-eye principle for the use of the corresponding account, for example by means of password division.
* An encryption ban enforced under Windows 2000 by means of a blank recovery policy will stop working in Windows XP. Under Windows XP, disabling the encryption option will allow users to use the encrypting file system in the properties of the Computer Configuration | Windows Settings | Security Settings | Policy Public Key | File system is encrypted | Properties | Users are allowed to use the encrypting file system. Starting with Windows Vista / Server 2003, the use of EFS under Computer Configuration | Windows Settings | Security Settings | Public Key Policies | Encrypting file system can be configured by a click with the right mouse button and choice of properties in the menu then displayed.
* The use of a separate recovery agent does not provide full protection against the administrator, who can always reset a user's password to subsequently log in as a user and access its encrypted files. In Windows XP, however, this only applies to domain accounts. If the password for a local user account is reset in Windows XP, access to its encrypted files will be blocked for all users. To prevent the loss of encrypted local user data, Windows XP offers the so-called Password Reset Disk (PRD). Creating such a password reset disk for a domain user account is not possible according to Microsoft.
* The private key of the recovery agent should be deleted from the system after it has been exported to a storage medium. The storage medium must be kept in a safe place and access should be on the four-eye principle. It is recommended that you make a separate and secure backup copy of the key.
* When using EFS, it is important to secure all private keys. For this, all profile data on all computers, ie all directories below Documents and Settings / <username>, which also contain all user keys and certificates, must be recorded by the backup mechanism.
* If EFS is used without a server-side user profile (roaming profile), different keys are used to encrypt and decrypt the FEK, depending on different local profiles, since these are stored in the profile of a user (encrypted) , Also in this case it is important to secure all keys. In particular, encrypted data from one computer that has been backed up to tape can not be re-recorded on another computer, since a successful decryption due to different keys is not possible.
* The use of a PKI for issuing EFS certificates may be useful in a company or a public authority. In particular, when using server-side stored user profiles, this promises a simpler key management and backup.
* Encrypting system files (files with set system attribute) and compressed files is not possible on Windows XP. Furthermore, compressed files from Windows Vista / Server 2003 can be encrypted. At the same time the compression is reduced.
* The Windows boot file autoexec.bat must be protected against encryption by preventing write access to users. Otherwise, a denial-of-service attack is possible.
* If encrypted data is processed or printed with programs, such as a text editor, after decryption, then temporary files are usually created that contain data in plain text. Depending on the program, these can persist even after processing. Depending on the storage location (temp directories or spool area) and access authorization, access by unauthorized third parties is also possible.
* In order to achieve greater security when processing EFS encrypted files, it should be considered whether it is appropriate to include directories that typically contain temporary data (Temp, Spool), f To label the encryption. It has to be taken into account, which data sets are stored in these directories and which programs use these directories. With very frequent accesses to large amounts of data, the encryption can lead to a loss of performance. Encrypting the Temp directory may cause updates problems.
* As of Windows Vista / Server 2003, EFS encryption can also be used by other users' certificates to allow access to the encrypted data.
* As of Windows XP, the ability to encrypt offline files has been introduced. The entire Offline Files store, which contains files for all users, is encrypted using a computer-specific key. Encryption is transparent to users and can only be enabled or disabled by administrators. The activation takes place in the settings of Windows Explorer or by the definition of the corresponding group configuration Computer Configuration | Administrative Templates | Network | Offline Files | Encrypt the offline file.
* Data encrypted with EFS is encrypted and decrypted on the computer where this data is stored. This means, in particular, that data encrypted on a server is stored in the clear over the network when accessed by a client (SMB protocol). If the data must also be protected during the transmission, depending on the protection requirements determined, additional measures to secure the network communication are required. For example, EFS can be used with WebDAV (Web Digital Authoring and Versioning), SSL or IPSec, see also M 5.90 Using IPSec under Windows.
* Windows XP introduced a new mechanism for working with files via Web sharing with WebDAV. If EFS is used with WebDAV, a locally encrypted file is transmitted in encrypted form to the server and stored there. A file requested via WebDAV is also transmitted in encrypted form by the server and locally decrypted. Thus, through the use of WebDAV an encrypted transmission over the network is possible.
* If EFS is used for local user accounts, the registry key must be encrypted using the syskey command using a password. Only then can the local account passwords be protected against being reset by hacking tools.
* EFS is only a cost effective alternative to file encryption with other tools when used properly. EFS can be used on laptops, for example, to compensate for the lack of physical security so that data can be protected from unauthorized access to the operating system mechanisms. However, the use of EFS is not always appropriate, so it must be decided for each purpose whether EFS should be used.


As an alternative to encryption at the file system level, the use of full disk encryption avoids the disadvantages of EFS described above. This is especially true for mobile computers (see M 2.442 Use of client operating systems from Windows Vista on mobile systems).



